<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat An√¥nimo üî•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      overflow: hidden;
    }
    #messages { scroll-behavior: smooth; }
    .message-enter {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Cabe√ßalho -->
  <header class="bg-gray-900 shadow-lg p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-white flex items-center gap-2">
      üí¨ Chat An√¥nimo
      <span id="connection-indicator" class="status-dot bg-yellow-400"></span>
    </h1>
    <span id="user-status" class="text-sm text-gray-400">Conectando...</span>
  </header>

  <!-- Mensagens -->
  <main id="messages" class="flex-1 overflow-y-auto px-4 py-3 space-y-3 bg-[#161b22]">
    <div class="text-center text-gray-500 text-sm">Bem-vindo! Suas mensagens aparecem aqui em tempo real.</div>
  </main>

  <!-- Formul√°rio -->
  <form id="message-form" class="bg-gray-900 p-3 flex items-center gap-2 border-t border-gray-800">
    <input id="username-input" type="text" placeholder="Seu nome (opcional)"
      class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 w-1/4 text-sm text-white focus:ring-2 focus:ring-blue-600 outline-none transition" />
    <input id="message-input" type="text" placeholder="Digite sua mensagem..." required autocomplete="off"
      class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-600 outline-none transition" />
    <button type="submit"
      class="bg-blue-600 hover:bg-blue-700 transition text-white rounded-lg px-4 py-2 font-semibold shadow-lg flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal">
        <path d="m3 3 3 9-3 9 19-9Z" />
        <path d="M6 12h16" />
      </svg>
      Enviar
    </button>
  </form>

  <!-- Firebase e Chat -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDAQS7qpWTDH7itAgn1eAJIeLOfVxy__cM",
      authDomain: "chat-firebase-efcbe.firebaseapp.com",
      databaseURL: "https://chat-firebase-efcbe-default-rtdb.firebaseio.com",
      projectId: "chat-firebase-efcbe",
      storageBucket: "chat-firebase-efcbe.firebasestorage.app",
      messagingSenderId: "376919463932",
      appId: "1:376919463932:web:4b2139df551d0a026ac479",
      measurementId: "G-R14XVTJBFL"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const messagesDiv = document.getElementById("messages");
    const form = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");
    const usernameInput = document.getElementById("username-input");
    const userStatus = document.getElementById("user-status");
    const connectionIndicator = document.getElementById("connection-indicator");

    let currentUserId = null;
    let connected = false;

    // Fun√ß√µes de status visual
    function setStatus(text, color) {
      userStatus.textContent = text;
      connectionIndicator.className = `status-dot ${color}`;
    }

    // Tenta autenticar e reconectar
    function connectFirebase() {
      setStatus("Conectando...", "bg-yellow-400");
      signInAnonymously(auth)
        .then(() => setStatus("Conectado ‚úÖ", "bg-green-500"))
        .catch((e) => {
          console.error("Erro de autentica√ß√£o:", e);
          setStatus("Erro de conex√£o ‚ùå", "bg-red-500");
          setTimeout(connectFirebase, 4000); // tenta reconectar
        });
    }

    // Estado de autentica√ß√£o
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        connected = true;
        setStatus("Conectado ‚úÖ", "bg-green-500");
        loadMessages();
      } else {
        connected = false;
        setStatus("Reconectando...", "bg-yellow-400");
        connectFirebase();
      }
    });

    // Escuta mensagens em tempo real
    function loadMessages() {
      const messagesRef = ref(db, "messages");
      onChildAdded(messagesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) displayMessage(data);
      });
    }

    // Exibe mensagem
    function displayMessage(data) {
      const div = document.createElement("div");
      const isMine = data.userId === currentUserId;

      div.className = `message-enter p-3 rounded-lg max-w-[80%] break-words shadow-md ${
        isMine
          ? "bg-blue-600 text-white ml-auto rounded-br-none"
          : "bg-gray-800 text-gray-100 mr-auto rounded-bl-none"
      }`;

      div.innerHTML = `
        <div class="text-xs opacity-70 mb-1 font-semibold">${data.username || "An√¥nimo"}</div>
        <div>${data.text}</div>
        <div class="text-[10px] opacity-50 mt-1 text-right">
          ${data.timestamp
            ? new Date(data.timestamp).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })
            : "agora"}
        </div>
      `;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Enviar mensagem
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!connected) {
        alert("Voc√™ est√° offline. Tente novamente quando estiver conectado.");
        return;
      }

      const text = messageInput.value.trim();
      if (!text || !currentUserId) return;

      const username = usernameInput.value.trim() || "An√¥nimo";
      const messagesRef = ref(db, "messages");

      try {
        await push(messagesRef, {
          userId: currentUserId,
          username,
          text,
          timestamp: Date.now()
        });
        messageInput.value = "";
      } catch (err) {
        console.error("Erro ao enviar:", err);
        setStatus("Erro ao enviar ‚ùå", "bg-red-500");
      }
    });

    // Inicia conex√£o
    connectFirebase();
  </script>
</body>
</html>
