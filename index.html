<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Simples com Firebase</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte e cores básicas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #c9d1d9; /* Cor do texto claro */
        }
        /* Estilo para a barra de chat */
        #chat-container {
            max-width: 90%;
            margin: 20px auto;
            height: calc(100vh - 40px); /* Altura total da tela menos margem */
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background-color: #161b22; /* Fundo do container */
        }
        /* Área das mensagens */
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: #161b22;
        }
        /* Estilo de mensagem individual (seu original) */
        .message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .my-message {
            background-color: #2f3e58; /* Azul escuro */
            margin-left: auto;
            text-align: right;
        }
        .other-message {
            background-color: #21262d; /* Cinza escuro */
            margin-right: auto;
            text-align: left;
        }
        .message-header {
            font-size: 0.8rem;
            font-weight: bold;
            color: #58a6ff; /* Azul claro para o nome */
            margin-bottom: 2px;
        }
        .message-content {
            font-size: 0.9rem;
        }
        .message-timestamp {
            font-size: 0.7rem;
            color: #8b949e; /* Cinza claro para o timestamp */
            margin-top: 4px;
        }
        /* Formulário de input */
        #message-form {
            padding: 12px 16px;
            border-top: 1px solid #21262d;
            background-color: #161b22;
            display: flex;
            gap: 8px;
        }
        #nameInput, #messageInput {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 10px;
            border-radius: 6px;
            outline: none;
            transition: border-color 0.2s;
        }
        #nameInput:focus, #messageInput:focus {
            border-color: #58a6ff;
        }
        #nameInput {
            width: 150px;
        }
        #messageInput {
            flex-grow: 1;
        }
        #sendButton {
            background-color: #238636; /* Verde */
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #sendButton:hover {
            background-color: #2ea043;
        }
        /* Estilo para a área de status */
        #status {
            padding: 8px 16px;
            background-color: #1f6feb; /* Azul de status */
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }
        /* Estilo para o modal de aviso */
        #custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #21262d;
            color: #c9d1d9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .alert-button {
            background-color: #58a6ff;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <div id="status" class="bg-blue-600 text-white p-2 text-sm">Carregando Chat...</div>
        <div id="messages" class="flex flex-col space-y-2">
            <!-- Mensagens serão injetadas aqui -->
        </div>
        
        <form id="message-form">
            <input type="text" id="nameInput" placeholder="Seu nome" required maxlength="20">
            <input type="text" id="messageInput" placeholder="Digite sua mensagem..." required>
            <button type="submit" id="sendButton">Enviar</button>
        </form>
    </div>

    <div id="custom-alert">
        <p id="alert-message"></p>
        <button id="alert-ok-button" class="alert-button">OK</button>
    </div>

    <!-- FIREBASE SDKs (Usando Módulos Modernos para Firestore) -->
    <script type="module">
        // Importações necessárias para Firebase e Firestore
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar log de debug (opcional, mas útil)
        setLogLevel('Debug');

        // ====================================================================
        // 1. VARIÁVEIS DE AMBIENTE E INICIALIZAÇÃO
        // ====================================================================
        // O Canvas fornece as configurações necessárias através destas variáveis globais
        // Se __firebase_config estiver indefinido, ele será um objeto vazio {}.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const nameInput = document.getElementById('nameInput');
        const messageInput = document.getElementById('messageInput');
        const messageForm = document.getElementById('message-form');

        // ====================================================================
        // 2. FUNÇÕES DE UTILIDADE
        // ====================================================================

        // Custom Alert (Substitui alert() para não quebrar o iFrame)
        function customAlert(message) {
            const alertBox = document.getElementById('custom-alert');
            document.getElementById('alert-message').textContent = message;
            alertBox.style.display = 'block';
            document.getElementById('alert-ok-button').onclick = () => {
                alertBox.style.display = 'none';
            };
        }

        // Rola a div de mensagens para o final
        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Formata o timestamp do Firebase para exibição
        function formatTimestamp(timestamp) {
            if (!timestamp) return '...';
            // Converte timestamp do Firestore (objeto) para data JS
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // ====================================================================
        // 3. INICIALIZAÇÃO DO FIREBASE E AUTENTICAÇÃO
        // ====================================================================

        async function initializeFirebase() {
            try {
                // Removemos o throw new Error aqui. Apenas avisamos e tentamos a inicialização.
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("AVISO: Variável __firebase_config não fornecida pelo ambiente (ou está vazia). Tentando inicializar, mas o Firestore pode falhar.");
                    statusDiv.textContent = `AVISO: Configuração do Firebase vazia. Tentando iniciar de forma limitada.`;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Tenta autenticar usando o token fornecido ou anonimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener para garantir que a autenticação esteja completa
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        statusDiv.textContent = `Logado como Usuário ID: ${currentUserId.substring(0, 8)}...`;
                        
                        // Carrega o último nome de usuário salvo ou usa um padrão
                        const savedUsername = localStorage.getItem('chatUsername');
                        nameInput.value = savedUsername || `User_${Math.floor(Math.random() * 10000)}`;
                        
                        setupMessageListener(); // Inicia o listener de mensagens após a autenticação
                    } else {
                        currentUserId = null;
                        isAuthReady = false;
                        // Mantenha o status de aviso se a configuração estiver vazia, caso contrário, falha na autenticação
                        if (Object.keys(firebaseConfig).length !== 0) {
                            statusDiv.textContent = 'Autenticação falhou. Tente novamente.';
                        }
                    }
                });

            } catch (e) {
                console.error("Erro fatal na inicialização do Firebase:", e);
                statusDiv.textContent = `ERRO FATAL: ${e.message}. O chat não está funcional.`;
                customAlert(`Erro fatal: ${e.message}. O chat não está funcional. Verifique o console.`);
            }
        }

        // ====================================================================
        // 4. LÓGICA DO CHAT (Receber e Enviar Mensagens)
        // ====================================================================

        // Função para renderizar uma mensagem no DOM
        function renderMessage(doc) {
            const data = doc.data();
            const messageId = doc.id;
            const isMine = data.userId === currentUserId;
            
            // Cria ou atualiza o elemento da mensagem
            let messageElement = document.getElementById(`msg-${messageId}`);
            const isNew = !messageElement;

            if (isNew) {
                messageElement = document.createElement('div');
                messageElement.id = `msg-${messageId}`;
            }

            // Garante que a classe e a direção estejam corretas
            messageElement.className = `message ${isMine ? 'my-message ml-auto' : 'other-message mr-auto'}`;

            const usernameDisplay = isMine ? 'Você' : (data.username || 'Anônimo');

            messageElement.innerHTML = `
                <div class="message-header">${usernameDisplay}</div>
                <div class="message-content">${data.text}</div>
                <div class="message-timestamp">${formatTimestamp(data.timestamp)}</div>
            `;
            
            if (isNew) {
                messagesDiv.appendChild(messageElement);
            }

            // Rola para o final se for uma nova mensagem
            if (isNew) {
                scrollToBottom();
            }
        }

        // Configura o listener do Firestore para receber mensagens em tempo real
        function setupMessageListener() {
            if (!isAuthReady || !db) return;

            // Caminho para a coleção pública (necessário para chat multi-usuário)
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            
            // Cria a query: ordena por timestamp para garantir a ordem correta
            const q = query(collection(db, messagesCollectionPath), orderBy('timestamp'));
            
            // onSnapshot é o listener em tempo real
            onSnapshot(q, (snapshot) => {
                
                snapshot.docChanges().forEach((change) => {
                    const doc = change.doc;
                    
                    if (change.type === "added" || change.type === "modified") {
                        renderMessage(doc); 
                    }
                    
                    // Se for um documento removido (moderação/exclusão)
                    if (change.type === "removed") {
                        const existing = document.getElementById(`msg-${doc.id}`);
                        if (existing) existing.remove();
                    }
                });
                
            }, (error) => {
                console.error("Erro no listener do Firestore: ", error);
                statusDiv.textContent = 'ERRO: Falha na conexão de tempo real. Verifique o console.';
                customAlert(`Erro ao carregar mensagens: ${error.message}.`);
            });
        }

        // Envio de mensagem
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = nameInput.value.trim();
            const text = messageInput.value.trim();

            if (!username) {
                customAlert('Por favor, digite seu nome.');
                return;
            }

            if (!text) {
                customAlert('Por favor, digite uma mensagem.');
                return;
            }

            if (!currentUserId) {
                customAlert('Aguardando autenticação. Tente novamente em alguns segundos.');
                return;
            }

            // Salva o nome de usuário localmente (para futuras mensagens)
            localStorage.setItem('chatUsername', username);

            try {
                // Salva a mensagem no Firestore
                const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                await addDoc(collection(db, messagesCollectionPath), {
                    userId: currentUserId,
                    username: username,
                    text: text,
                    timestamp: serverTimestamp() // Hora do servidor Firebase
                });
                
                messageInput.value = ''; // Limpa o input
            } catch (e) {
                console.error("Erro ao enviar mensagem: ", e);
                customAlert('Erro ao enviar. Verifique o console para detalhes.');
            }
        });

        // ====================================================================
        // 5. INÍCIO DO APP
        // ====================================================================
        initializeFirebase();

    </script>
</body>
</html>
