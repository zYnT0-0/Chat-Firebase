<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Simples com Firebase</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte e cores básicas */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #c9d1d9; /* Cor do texto claro */
        }
        /* Estilo para a barra de chat */
        #chat-container {
            max-width: 90%;
            margin: 20px auto;
            height: calc(100vh - 40px); /* Altura total da tela menos margem */
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background-color: #161b22; /* Fundo do container */
        }
        /* Área das mensagens */
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }
        /* Estilo da mensagem do usuário */
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        /* Estilo da sua própria mensagem */
        .my-message {
            background-color: #007bff; /* Azul vibrante */
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 2px;
        }
        /* Estilo das mensagens de outros usuários */
        .other-message {
            background-color: #21262d; /* Cinza escuro */
            color: #c9d1d9;
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 2px;
        }
        /* Cabeçalho da mensagem (nome) */
        .message-header {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.7;
        }
        /* Formulário de input */
        #message-form {
            padding: 15px;
            border-top: 1px solid #30363d;
            background-color: #0d1117;
            display: flex;
            gap: 10px;
        }
        /* Input de texto */
        #message-input {
            flex-grow: 1;
            background-color: #21262d;
            border: 1px solid #30363d;
            color: white;
            padding: 12px;
            border-radius: 8px;
        }
        #message-input:focus {
             outline: 2px solid #007bff;
             border-color: #007bff;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <header class="p-4 bg-gray-800 text-white shadow-md rounded-t-xl flex justify-between items-center">
            <h2 class="text-xl font-bold">Chat Público (Tempo Real)</h2>
            <div id="user-status" class="text-sm">Conectando...</div>
        </header>

        <div id="messages" class="flex flex-col space-y-3">
            <!-- Mensagens serão inseridas aqui pelo JavaScript -->
            <div class="text-center text-sm text-gray-500 py-4">
                Bem-vindo ao chat!
            </div>
        </div>

        <form id="message-form">
            <input type="text" id="username-input" placeholder="Seu Nome (opcional)" class="p-2 w-1/4 rounded-lg bg-gray-700 border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-white" />
            <input type="text" id="message-input" placeholder="Digite sua mensagem..." required autocomplete="off">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
            </button>
        </form>
    </div>

    <!-- Importa as bibliotecas Firebase (Versão modular recomendada) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // ====================================================================
        // 1. CONFIGURAÇÃO E INICIALIZAÇÃO DO FIREBASE (MANDATÓRIO)
        // ====================================================================

        // Variáveis globais (fornecidas pelo ambiente)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, currentUserId = null, isAuthReady = false;

        // Elementos do DOM
        const messagesDiv = document.getElementById('messages');
        const form = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const usernameInput = document.getElementById('username-input');
        const userStatus = document.getElementById('user-status');
        
        // Função para garantir que a área de mensagens desça até o final
        const scrollToBottom = () => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        // Função para inicializar o Firebase e autenticar o usuário
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticação: Tenta com token customizado (ambiente) ou anonimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Monitora o estado da autenticação
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        userStatus.textContent = `Logado como: ${currentUserId.substring(0, 6)}...`;
                        console.log("Usuário autenticado:", currentUserId);
                        // Inicia o listener de mensagens assim que a autenticação estiver pronta
                        setupMessageListener(); 
                        
                        // Define um nome de usuário padrão (o 6 primeiros dígitos do UID)
                        if (!localStorage.getItem('chatUsername')) {
                            localStorage.setItem('chatUsername', `User_${currentUserId.substring(0, 6)}`);
                        }
                        usernameInput.value = localStorage.getItem('chatUsername');

                    } else {
                        isAuthReady = true;
                        console.error("Erro na autenticação. Tentando novamente...");
                        // Se o token falhar, tenta autenticar anonimamente
                        signInAnonymously(auth).catch(e => console.error("Falha ao autenticar anonimamente:", e));
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                userStatus.textContent = "Erro de conexão.";
            }
        }

        // ====================================================================
        // 2. LISTENERS DE MENSAGENS (FIRESTORE)
        // ====================================================================

        function setupMessageListener() {
            // Caminho para a coleção de mensagens (Público, conforme regras de segurança)
            // /artifacts/{appId}/public/data/messages
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            const q = query(
                collection(db, messagesCollectionPath), 
                orderBy("timestamp", "asc") // Ordena pela hora de criação
            );

            // onSnapshot: Escuta mudanças em tempo real
            onSnapshot(q, (snapshot) => {
                // Limpa a área de mensagens para reconstruir a lista (método simples)
                messagesDiv.innerHTML = ''; 

                snapshot.forEach((doc) => {
                    const messageData = doc.data();
                    displayMessage(messageData);
                });
                
                scrollToBottom(); // Rola para a mensagem mais recente
            }, (error) => {
                console.error("Erro ao ouvir mensagens:", error);
            });
        }
        
        // ====================================================================
        // 3. FUNÇÃO DE RENDERIZAÇÃO
        // ====================================================================

        function displayMessage(data) {
            const isMyMessage = data.userId === currentUserId;
            const messageClass = isMyMessage ? 'my-message ml-auto' : 'other-message mr-auto';
            const alignment = isMyMessage ? 'text-right' : 'text-left';
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${messageClass} ${alignment}`;
            
            const nameElement = document.createElement('div');
            // Exibe o nome de usuário ou o ID (anonimamente)
            nameElement.className = 'message-header';
            nameElement.textContent = data.username || `User_${data.userId.substring(0, 6)}`;

            const textElement = document.createElement('p');
            textElement.textContent = data.text;
            
            const timeElement = document.createElement('div');
            timeElement.className = 'text-xs mt-1 opacity-50';
            
            // Converte o timestamp do Firestore para uma string legível
            let timeString = 'agora';
            if (data.timestamp && data.timestamp.seconds) {
                const date = new Date(data.timestamp.seconds * 1000);
                timeString = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }
            timeElement.textContent = timeString;

            messageElement.appendChild(nameElement);
            messageElement.appendChild(textElement);
            messageElement.appendChild(timeElement);
            messagesDiv.appendChild(messageElement);
        }

        // ====================================================================
        // 4. ENVIO DE MENSAGEM
        // ====================================================================

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = messageInput.value.trim();
            const username = usernameInput.value.trim() || `User_${currentUserId.substring(0, 6)}`;
            
            if (!text || !currentUserId) return;

            // Atualiza o nome de usuário localmente (para futuras mensagens)
            localStorage.setItem('chatUsername', username);

            try {
                // Salva a mensagem no Firestore
                const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                await addDoc(collection(db, messagesCollectionPath), {
                    userId: currentUserId,
                    username: username,
                    text: text,
                    timestamp: serverTimestamp() // Hora do servidor Firebase
                });
                
                messageInput.value = ''; // Limpa o input
                scrollToBottom(); // Rola para o fim
            } catch (e) {
                console.error("Erro ao enviar mensagem: ", e);
                // Exibe uma mensagem simples de erro
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'Erro ao enviar. Tente novamente.';
                errorDiv.className = 'text-red-500 text-center text-sm';
                messagesDiv.appendChild(errorDiv);
                scrollToBottom();
            }
        });

        // ====================================================================
        // 5. INÍCIO DO APP
        // ====================================================================
        initializeFirebase();

    </script>
</body>
</html>