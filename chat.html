<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat ‚Äî App (final)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
  :root{
    --bg:#0d1117; --panel:#0f1418; --muted:#c9d1d9;
    --mine:#5865F2; --other:#2f3136;
  }
  html,body{height:100%}
  body{background:var(--bg); color:var(--muted); font-family:Inter,system-ui; margin:0}
  .chat-container{display:flex; height:100vh}
  .main-chat-area{flex-grow:1; display:flex; flex-direction:column; max-width:100%}
  .messages{flex-grow:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px}
  .msg-bubble{display:inline-block; word-break:break-word; white-space:pre-wrap; border-radius:12px; padding:12px; box-shadow: 0 2px 6px rgba(0,0,0,.35)}
  .meta{font-size:12px; opacity:.78; margin-bottom:6px; display:flex; gap:10px; align-items:center}
  .meta .who{font-weight:600}
  .meta .time{font-size:11px; opacity:.8}
  .msg-bubble .actions{margin-top:8px; display:flex; gap:8px}
  .small-btn{padding:2px 6px; border-radius:4px; font-size:11px}
  
  /* Desktop friends list */
  .desktop-friends{width:280px; flex-shrink:0; background:var(--panel); border-left:1px solid #2d3748; padding:10px; display:none}
  @media (min-width: 1024px){.desktop-friends{display:block}.main-chat-area{max-width:calc(100% - 280px)}}
  
  /* Mobile overlay for friends */
  .friends-overlay{position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; display:none; justify-content:flex-end}
  .friends-panel{width:85%; max-width:320px; background:var(--panel); height:100%; padding:15px; overflow-y:auto}
  @media (max-width: 1023px){.friends-overlay.active{display:flex}}
</style>
</head>

<body>
<div class="chat-container">
    
    <div class="main-chat-area">
        <div class="p-3 bg-gray-900 flex justify-between items-center border-b border-gray-700 sticky top-0 z-10">
            <div class="flex gap-2">
                <button id="tabGlobal" class="px-3 py-1 rounded bg-gray-800 text-white text-sm">Global</button>
                <button id="tabDM" class="px-3 py-1 rounded bg-gray-700 text-gray-300 text-sm">DM</button>
            </div>
            <div class="flex items-center gap-4">
                <span id="status" class="text-sm">Carregando...</span>
                <button id="friendsToggle" class="relative text-white lg:hidden">
                    Amigos 
                    <span id="notifCount" class="absolute -top-1 -right-1 bg-red-600 text-xs rounded-full w-4 h-4 leading-4 text-center">0</span>
                </button>
            </div>
        </div>

        <div id="messages" class="messages">
            <div class="text-gray-400 text-center mt-6">Conectando ao chat...</div>
        </div>

        <div id="typingNotice" class="text-xs p-2 text-gray-500 min-h-[20px]"></div>

        <div class="p-3 bg-gray-900 border-t border-gray-700">
            <div class="mb-2 flex justify-between items-center text-xs">
                <span id="sendMode" class="text-gray-400">Modo: Global</span>
                <span class="text-gray-500 flex gap-3">
                    <a href="profile.html" class="text-xs hover:text-white">Meu Perfil</a>
                    <a id="adminLink" href="admin.html" class="text-xs text-red-400 hover:text-red-300 hidden">Admin</a>
                    <a id="logoutLink" href="#" class="text-xs text-red-500 hover:text-red-400">Sair</a>
                </span>
            </div>
            <div class="flex gap-2">
                <textarea id="messageInput" placeholder="Sua mensagem (suporta Markdown)" rows="1" class="flex-grow p-2 rounded bg-gray-800 border border-gray-700 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Enviar</button>
            </div>
        </div>
    </div>
    
    <div class="desktop-friends">
        <h3 class="font-semibold text-lg mb-4">Amigos e Contatos</h3>

        <div class="mb-4">
            <h4 class="text-sm mb-2 text-gray-400">Solicita√ß√µes Pendentes (<span id="notifCountDesktop">0</span>)</h4>
            <div id="friendRequestsListDesktop" class="space-y-2 text-sm">
                <div class="text-gray-500 text-xs">Sem solicita√ß√µes.</div>
            </div>
        </div>
        
        <div class="mb-4">
            <h4 class="text-sm mb-2 text-gray-400">Amigos</h4>
            <div id="friendsAreaDesktop" class="space-y-2 text-sm">
                <div class="text-gray-500 text-xs">Sem amigos.</div>
            </div>
        </div>

        <div>
            <h4 class="text-sm mb-2 text-gray-400">Buscar Usu√°rio</h4>
            <input id="friendSearchDesktop" placeholder="Digite 3+ letras" class="w-full p-2 rounded bg-gray-800 border border-gray-700 mb-2 text-sm"/>
            <div id="recommendationsDesktop" class="space-y-2 text-xs"></div>
        </div>
    </div>


    <div id="friendsOverlay" class="friends-overlay">
        <div class="friends-panel">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-semibold text-xl">Amigos e Contatos</h3>
                <button id="closeFriends" class="text-2xl text-gray-400">&times;</button>
            </div>

            <div class="mb-6">
                <h4 class="text-sm mb-2 text-gray-400">Solicita√ß√µes Pendentes (<span id="notifCountMobile">0</span>)</h4>
                <div id="friendRequestsList" class="space-y-2 text-sm">
                    <div class="text-gray-500 text-xs">Sem solicita√ß√µes.</div>
                </div>
            </div>
            
            <div class="mb-6">
                <h4 class="text-sm mb-2 text-gray-400">Amigos</h4>
                <div id="friendsArea" class="space-y-2 text-sm">
                    <div class="text-gray-500 text-xs">Sem amigos.</div>
                </div>
            </div>

            <div>
                <h4 class="text-sm mb-2 text-gray-400">Buscar Usu√°rio</h4>
                <input id="friendSearch" placeholder="Digite 3+ letras" class="w-full p-2 rounded bg-gray-800 border border-gray-700 mb-2 text-sm"/>
                <div id="recommendations" class="space-y-2 text-xs"></div>
            </div>

        </div>
    </div>
</div>

<script type="module">
/* chat.html final: Global + DM + friend requests + typing + admin force/logout + blocked write check */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import {
  getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved,
  get, set, update, onValue, remove, off, onDisconnect
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// CHAVE DE API CORRIGIDA E COMPLETA (a mesma usada no profile.html)
const firebaseConfig = {
  apiKey: "AIzaSyDAQS7qpWTDH7itAgn1eAJIeLOfVxy__cM",
  authDomain: "chat-firebase-efcbe.firebaseapp.com",
  databaseURL: "https://chat-firebase-efcbe-default-rtdb.firebaseio.com",
  projectId: "chat-firebase-efcbe",
  storageBucket: "chat-firebase-efcbe.firebasestorage.app",
  messagingSenderId: "376919463932",
  appId: "1:376919463932:web:4b2139df551d0a026ac479",
  measurementId: "G-R14XVTJBFL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// UI refs
const statusEl = document.getElementById('status');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const sendModeEl = document.getElementById('sendMode');
const typingNotice = document.getElementById('typingNotice');

const friendsToggle = document.getElementById('friendsToggle');
const friendsOverlay = document.getElementById('friendsOverlay');
const closeFriends = document.getElementById('closeFriends');

const friendSearch = document.getElementById('friendSearch');
const friendSearchDesktop = document.getElementById('friendSearchDesktop');
const recommendations = document.getElementById('recommendations');
const recommendationsDesktop = document.getElementById('recommendationsDesktop');
const friendsArea = document.getElementById('friendsArea');
const friendsAreaDesktop = document.getElementById('friendsAreaDesktop');
const friendRequestsList = document.getElementById('friendRequestsList');
const friendRequestsListDesktop = document.getElementById('friendRequestsListDesktop');

const tabGlobal = document.getElementById('tabGlobal');
const tabDM = document.getElementById('tabDM');
const adminLink = document.getElementById('adminLink');
const notifCountEl = document.getElementById('notifCount');
const notifCountElDesktop = document.getElementById('notifCountDesktop');
const logoutLink = document.getElementById('logoutLink');

let currentUserUid = localStorage.getItem('chat_user_uid') || null;
let currentUsername = localStorage.getItem('chat_user_username') || 'An√¥nimo';
let authUid = null;
let currentRoomId = null; // null = global
let markedParse = window.marked;

// usernames cache
let allUsernames = {};
onValue(ref(db, 'usernames'), snap=>{
  allUsernames = snap.exists() ? snap.val() : {};
  // refresh recommendations if user is typing in search
  const active = document.activeElement;
  if(active === friendSearch){ doSearchAndRender(active.value, recommendations); }
  if(active === friendSearchDesktop){ doSearchAndRender(active.value, recommendationsDesktop); }
});

// helpers
function renderMarkdown(md){ const html = markedParse.parse(md||''); return DOMPurify.sanitize(html); }
function timeStr(ts){ try{ return new Date(ts).toLocaleTimeString(); }catch(e){ return ''; } }
function logError(e){ console.error('CHAT ERROR', e); }

// message element (omitted for brevity, assume original logic is fine)
function createMessageElement(id, data, isPrivate=false){
  // (Full element creation logic as provided in previous steps)
  const wrapper = document.createElement('div');
  wrapper.className = 'fade flex';
  wrapper.style.justifyContent = (data.userId === currentUserUid) ? 'flex-end' : 'flex-start';
  wrapper.dataset.msgId = id;

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.style.background = (data.userId === currentUserUid) ? 'var(--mine)' : 'var(--other)';
  bubble.style.color = (data.userId === currentUserUid) ? 'white' : '#d6dbe3';
  bubble.style.maxWidth = '78%';

  const meta = document.createElement('div'); meta.className = 'meta';
  const who = document.createElement('div'); who.className = 'who'; who.textContent = data.username || 'An√¥nimo';
  const t = document.createElement('div'); t.className = 'time'; t.textContent = (data.timestamp ? `‚Ä¢ ${timeStr(data.timestamp)}` : '');
  meta.appendChild(who); meta.appendChild(t);

  const content = document.createElement('div'); content.className = 'content'; content.innerHTML = renderMarkdown(data.text || '');

  bubble.appendChild(meta); bubble.appendChild(content);

  if(data.userId === currentUserUid){
    const actions = document.createElement('div'); actions.className = 'actions';
    const editBtn = document.createElement('button'); editBtn.className = 'small-btn text-xs text-gray-200'; editBtn.textContent = 'editar';
    const delBtn = document.createElement('button'); delBtn.className = 'small-btn text-xs text-red-400'; delBtn.textContent = 'apagar';

    const openModal = (title, content, onConfirm, confirmOnly=false)=>{ /* (modal function not included for brevity, assumed it exists or is simple pop-up) */ };

    editBtn.onclick = ()=> {
      const newText = prompt('Editar mensagem:', data.text);
      if(!newText.trim()) return;
      const path = isPrivate ? `privateMessages/${currentRoomId}/messages/${id}` : `messages/${id}`;
      update(ref(db, path), { text:newText, editedAt: Date.now() }).catch(logError);
    };

    delBtn.onclick = ()=> {
      if(!confirm('Tem certeza que deseja apagar esta mensagem?')) return;
      const path = isPrivate ? `privateMessages/${currentRoomId}/messages/${id}` : `messages/${id}`;
      remove(ref(db, path)).catch(logError);
    };

    actions.appendChild(editBtn); actions.appendChild(delBtn);
    bubble.appendChild(actions);
  }

  wrapper.appendChild(bubble);
  return wrapper;
}
// END message element logic

// typing
let typingTimeout = null;
function setTyping(isTyping){
  const room = currentRoomId || 'global';
  const tRef = ref(db, `typing/${room}/${currentUserUid}`);
  if(isTyping){
    set(tRef, { uid: currentUserUid, username: currentUsername, at: Date.now() }).catch(()=>{});
    if(typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=> { remove(tRef).catch(()=>{}); }, 4000);
  } else {
    remove(tRef).catch(()=>{});
    if(typingTimeout) clearTimeout(typingTimeout);
  }
}

messageInput.addEventListener('input', ()=> { setTyping(true); });
window.addEventListener('blur', ()=> setTyping(false));
window.addEventListener('beforeunload', ()=> setTyping(false));

// watch typing in a room (keeps single listener)
let typingWatchRef = null;
function watchTypingForRoom(roomId){
  if(typingWatchRef) off(typingWatchRef);
  const rr = ref(db, `typing/${roomId}`);
  typingWatchRef = rr;
  onValue(rr, snap=>{
    const obj = snap.val() || {};
    const others = Object.values(obj).filter(o => o.uid !== currentUserUid);
    if(others.length === 0){ typingNotice.textContent = ''; return; }
    const names = others.slice(0,3).map(o => o.username || o.uid);
    typingNotice.textContent = names.join(', ') + (others.length > 1 ? ' est√£o digitando...' : ' est√° digitando...');
  });
}

// listeners management for private rooms
let currentPrivateRef = null;
function detachPrivateListeners(){
  if(currentPrivateRef) { try{ off(currentPrivateRef); }catch(e){} currentPrivateRef = null; }
}

// global listeners (attach once)
let globalListenerAttached = false;
let displayedGlobal = new Set();

async function loadAndListenGlobal(){
  try{
    const refGlobal = ref(db, 'messages');
    // initial load
    const snap = await get(refGlobal);
    messagesEl.innerHTML = '';
    displayedGlobal.clear();
    if(snap.exists()){
      const data = snap.val();
      const keys = Object.keys(data).sort((a,b)=> (data[a].timestamp||0) - (data[b].timestamp||0));
      for(const k of keys){ displayedGlobal.add(k); messagesEl.appendChild(createMessageElement(k, data[k], false)); }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } else messagesEl.innerHTML = '<div class="text-gray-400 text-center">Sem mensagens p√∫blicas.</div>';

    if(!globalListenerAttached){
      onChildAdded(refGlobal, s=>{
        const id = s.key;
        if(displayedGlobal.has(id)) return;
        displayedGlobal.add(id);
        messagesEl.appendChild(createMessageElement(id, s.val(), false));
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
      onChildChanged(refGlobal, s=>{
        const id = s.key;
        const n = messagesEl.querySelector(`[data-msg-id="${id}"]`);
        if(n) n.replaceWith(createMessageElement(id, s.val(), false));
      });
      onChildRemoved(refGlobal, s=>{
        const id = s.key;
        const n = messagesEl.querySelector(`[data-msg-id="${id}"]`);
        if(n) n.remove();
        displayedGlobal.delete(id);
      });
      globalListenerAttached = true;
    }
    // watch typing on global
    watchTypingForRoom('global');
  }catch(e){ logError(e); }
}

// private room listener
async function listenPrivate(roomId){
  try{
    detachPrivateListeners();
    currentPrivateRef = ref(db, `privateMessages/${roomId}/messages`);
    const snap = await get(currentPrivateRef);
    messagesEl.innerHTML = '';
    if(snap.exists()){
      const data = snap.val();
      const keys = Object.keys(data).sort((a,b)=> (data[a].timestamp||0) - (data[b].timestamp||0));
      for(const k of keys) messagesEl.appendChild(createMessageElement(k, data[k], true));
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } else messagesEl.innerHTML = '<div class="text-gray-400 text-center">Sem mensagens nessa conversa.</div>';

    onChildAdded(currentPrivateRef, s=>{
      if(messagesEl.querySelector(`[data-msg-id="${s.key}"]`)) return;
      messagesEl.appendChild(createMessageElement(s.key, s.val(), true));
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
    onChildChanged(currentPrivateRef, s=>{
      const n = messagesEl.querySelector(`[data-msg-id="${s.key}"]`);
      if(n) n.replaceWith(createMessageElement(s.key, s.val(), true));
    });
    onChildRemoved(currentPrivateRef, s=>{
      const n = messagesEl.querySelector(`[data-msg-id="${s.key}"]`);
      if(n) n.remove();
    });
    watchTypingForRoom(roomId);
  }catch(e){ logError(e); }
}

// deterministic room ID
function roomIdFor(a,b){ return [a,b].sort().join('_'); }

// ensure auth
async function ensureAuth(){
  return new Promise((resolve)=>{
    if(auth.currentUser){ resolve(auth.currentUser); return; }
    const unsub = onAuthStateChanged(auth, (user)=>{
      if(user){ unsub(); resolve(user); }
    });
    signInAnonymously(auth).catch((e)=> console.warn('signInAnonymously failed', e));
  });
}

// force logout listener (admin action)
function watchForceLogout(){
  const fRef = ref(db, `users/${currentUserUid}/forceLogoutAt`);
  onValue(fRef, async snap=>{
    if(!snap.exists()) return;
    const ts = snap.val();
    if(ts > (Date.now() - 3000)){ // Check if timestamp is recent (prevents old flags from triggering)
      alert('Voc√™ foi deslogado pelo administrador.');
      try{ await fbSignOut(auth); }catch(e){}
      localStorage.clear();
      location.href = 'index.html';
    }
  });
}

// friends UI loaders
async function loadFriendsUI(snap){
  try{
    if(!currentUserUid) return; 
    const f = snap && snap.exists() ? snap.val() : {};
    
    const renderList = (el, friendsObj)=>{
      el.innerHTML = '';
      const uids = Object.keys(friendsObj);
      if(uids.length === 0){ el.innerHTML = '<div class="text-gray-500 text-xs">Sem amigos.</div>'; return; }

      for(const uid of uids){
        const name = friendsObj[uid].username || uid;
        const btn = document.createElement('button'); btn.className = 'w-full text-left px-3 py-2 bg-gray-800 rounded hover:bg-gray-700 transition-colors'; btn.textContent = name;
        btn.onclick = ()=> openPrivateWith(uid, name);
        el.appendChild(btn);
      }
    };
    // Fetch current friends list if snap is not provided (e.g., initial load)
    const s = snap || await get(ref(db, `users/${currentUserUid}/friends`));
    const friendsObj = s.exists() ? s.val() : {};

    renderList(friendsArea, friendsObj);
    renderList(friendsAreaDesktop, friendsObj);
    
  }catch(e){ logError(e); }
}

// watch friends and requests
function watchFriendsAndRequests(){
    if(!currentUserUid) return;

    // Watch friends list
    onValue(ref(db, `users/${currentUserUid}/friends`), loadFriendsUI);

    // Watch requests
    onValue(ref(db, `friendRequests/${currentUserUid}`), snap=>{
      const count = snap.exists() ? Object.keys(snap.val()).length : 0;
      notifCountEl.textContent = count;
      notifCountElDesktop.textContent = count;
      renderFriendRequests(snap, friendRequestsList);
      renderFriendRequests(snap, friendRequestsListDesktop);
    });
}

//friend requests rendering and listeners//
function renderFriendRequests(snap, outEl){
  outEl.innerHTML = '';
  if(!snap.exists()){ outEl.innerHTML = '<div class="text-gray-500 text-xs">Sem solicita√ß√µes.</div>'; return; }
  const reqs = snap.val();
  for(const fromUid in reqs){
    const r = reqs[fromUid];
    const row = document.createElement('div');
    row.className = 'request-row p-2 bg-[#111318] rounded border border-gray-700 flex justify-between items-center';
    const name = document.createElement('div'); name.textContent = r.username || fromUid;
    const actions = document.createElement('div');
    const accept = document.createElement('button'); accept.textContent='Aceitar'; accept.className='small-btn bg-blue-600 text-white mr-2 hover:bg-blue-700';
    const decline = document.createElement('button'); decline.textContent='Recusar'; decline.className='small-btn bg-gray-700 text-white hover:bg-gray-600';
    
    accept.onclick = async ()=>{
      try{
        const fromSnap = await get(ref(db, `users/${fromUid}`));
        const fromName = fromSnap.exists() ? fromSnap.val().username : 'Amigo';
        await set(ref(db, `users/${currentUserUid}/friends/${fromUid}`), { username: fromName, addedAt: Date.now() });
        await set(ref(db, `users/${fromUid}/friends/${currentUserUid}`), { username: currentUsername, addedAt: Date.now() });
        const id = roomIdFor(currentUserUid, fromUid);
        await update(ref(db, `privateMessages/${id}/participants`), { [currentUserUid]: true, [fromUid]: true });
        await remove(ref(db, `friendRequests/${currentUserUid}/${fromUid}`));
      }catch(e){ logError(e); alert('Erro ao aceitar'); }
    };
    decline.onclick = async ()=> { try{ await remove(ref(db, `friendRequests/${currentUserUid}/${fromUid}`)); }catch(e){ logError(e); alert('Erro ao recusar'); } };
    
    actions.appendChild(accept); actions.appendChild(decline);
    row.appendChild(name); row.appendChild(actions);
    outEl.appendChild(row);
  }
}

// search recommendations 
function doSearchAndRender(q, outEl){
  outEl.innerHTML = '';
  if(!q || q.length < 3) return;
  const low = q.toLowerCase();
  let added = 0;
  for(const unameKey of Object.keys(allUsernames)){
    if(added >= 12) break;
    if(unameKey.includes(low) && unameKey !== currentUsername.toLowerCase()){
      const uid = allUsernames[unameKey];
      if(uid === currentUserUid) continue;
      
      const row = document.createElement('div'); row.className='p-2 bg-[#111318] rounded flex justify-between items-center';
      const name = document.createElement('div'); name.textContent = unameKey; 
      
      const addBtn = document.createElement('button'); addBtn.textContent = 'Adicionar'; addBtn.className = 'small-btn bg-blue-600 text-white hover:bg-blue-700';
      addBtn.onclick = async ()=>{
        try{
          await set(ref(db, `friendRequests/${uid}/${currentUserUid}`), { username: currentUsername, from: currentUserUid, at: Date.now() });
          addBtn.textContent = 'Enviado';
        }catch(e){ logError(e); addBtn.textContent = 'Erro'; }
      };
      row.appendChild(name); row.appendChild(addBtn); outEl.appendChild(row);
      added++;
    }
  }
}

friendSearch.addEventListener('input', e => doSearchAndRender(e.target.value, recommendations));
friendSearchDesktop.addEventListener('input', e => doSearchAndRender(e.target.value, recommendationsDesktop));

// open private chat
async function openPrivateWith(uid, username){
  try{
    const id = roomIdFor(currentUserUid, uid);
    // ensure participants exist (DB rules allow this write only if current user is participant)
    const pRef = ref(db, `privateMessages/${id}/participants`);
    await update(pRef, { [currentUserUid]: true, [uid]: true });

    currentRoomId = id;
    sendModeEl.textContent = `Modo: DM (${username})`;
    await listenPrivate(id);
    tabDM.classList.add('bg-gray-800'); tabGlobal.classList.remove('bg-gray-800');
    friendsOverlay.style.display = 'none'; // Close overlay on mobile
  }catch(e){ logError(e); alert('Erro ao abrir DM: ' + e.message); }
}

// send message (check blocked/ban and write to correct path)
sendBtn.addEventListener('click', async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  
  try{
    // block/banned check
    const userSnap = await get(ref(db, `users/${currentUserUid}`));
    if(userSnap.exists()){
      const u = userSnap.val();
      if(u.isBanned){ alert('Voc√™ foi banido e n√£o pode enviar mensagens.'); return; }
      if(u.isBlocked){ alert('Voc√™ foi silenciado pelo administrador e n√£o pode enviar mensagens.'); return; }
    }

    const messageData = { userId: currentUserUid, username: currentUsername, text, timestamp: Date.now() };

    if(currentRoomId){
      await push(ref(db, `privateMessages/${currentRoomId}/messages`), messageData);
    } else {
      await push(ref(db, 'messages'), messageData);
    }
    
    messageInput.value = '';
    setTyping(false);
  }catch(e){ logError(e); alert('Erro ao enviar mensagem.'); }
});

// tabs behavior
tabGlobal.addEventListener('click', async ()=>{
  currentRoomId = null;
  sendModeEl.textContent = 'Modo: Global';
  tabGlobal.classList.add('bg-gray-800'); tabDM.classList.remove('bg-gray-800');
  detachPrivateListeners();
  await loadAndListenGlobal();
});

tabDM.addEventListener('click', ()=>{ 
    currentRoomId = 'DM-Placeholder'; 
    sendModeEl.textContent = 'Modo: DM';
    tabDM.classList.add('bg-gray-800'); tabGlobal.classList.remove('bg-gray-800'); 
    detachPrivateListeners();
    messagesEl.innerHTML = '<div class="text-gray-400 text-center">Selecione um amigo na lista para iniciar uma conversa privada.</div>'; 
});

// Mobile/Overlay Handlers
friendsToggle.addEventListener('click', ()=> { friendsOverlay.style.display = 'flex'; });
closeFriends.addEventListener('click', ()=> { friendsOverlay.style.display = 'none'; });

// logout (full sign out)
logoutLink.addEventListener('click', async (e)=>{
  e.preventDefault();
  setTyping(false); 
  try{ await fbSignOut(auth); }catch(e){ console.warn('signOut error', e); }
  localStorage.clear(); sessionStorage.clear();
  setTimeout(()=> location.href = 'index.html', 150);
});

// watch admin status to show admin link
async function displayAdminIf(uid){
  try{
    if(!uid) return;
    const adm = await get(ref(db, `admins/${uid}`));
    if(adm.exists() && adm.val() === true) adminLink.classList.remove('hidden');
    else adminLink.classList.add('hidden');
  }catch(e){ logError(e); }
}

// auth bootstrap
async function bootstrap(){
  try{
    const user = await ensureAuth();
    authUid = user.uid;
    
    // Check if local UID matches auth UID, if not, update.
    if(!currentUserUid || currentUserUid !== authUid){
      currentUserUid = authUid;
      localStorage.setItem('chat_user_uid', currentUserUid);
      // Force reload username if UID changes (e.g., first login)
      const userSnap = await get(ref(db, `users/${currentUserUid}`));
      if(userSnap.exists()) {
        currentUsername = userSnap.val().username;
        localStorage.setItem('chat_user_username', currentUsername);
      }
    }
    
    statusEl.textContent = 'Carregando...';

    // start global messages
    await loadAndListenGlobal();

    // presence tracking
    onValue(ref(db, '.info/connected'), snap=>{
      if(snap.val() === true){
        try{ 
          set(ref(db, `status/${currentUserUid}`), { state:'online', last_changed: Date.now() }); 
          onDisconnect(ref(db, `status/${currentUserUid}`)).set({ state:'offline', last_changed: Date.now() }); 
        }catch(e){}
        statusEl.innerHTML = '<span class="text-green-500">üü¢ Online</span>';
      } else statusEl.innerHTML = '<span class="text-red-500">üî¥ Offline</span>';
    });
    
    // watch force logout flag and admin status
    watchForceLogout();
    displayAdminIf(currentUserUid);

    // initial friends UI and listeners
    watchFriendsAndRequests();

    statusEl.textContent = 'Pronto';
  }catch(e){ logError(e); statusEl.textContent = 'Erro'; }
}
bootstrap();

</script>
</body>
</html>
