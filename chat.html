<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat â€” App (final)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<style>
  :root{
    --bg:#0d1117; --panel:#0f1418; --muted:#c9d1d9;
    --mine:#5865F2; --other:#2f3136;
  }
  html,body{height:100%}
  body{background:var(--bg); color:var(--muted); font-family:Inter,system-ui; margin:0}
  .chat-container{display:flex; height:100vh}
  .main-chat-area{flex-grow:1; display:flex; flex-direction:column; max-width:100%}
  .messages{flex-grow:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px}
  .msg-bubble{display:inline-block; word-break:break-word; white-space:pre-wrap; border-radius:12px; padding:12px; box-shadow: 0 2px 6px rgba(0,0,0,.35)}
  .meta{font-size:12px; opacity:.78; margin-bottom:6px; display:flex; gap:10px; align-items:center}
  .meta .who{font-weight:600}
  .meta .time{font-size:11px; opacity:.6}
  .msg-mine{background:var(--mine); color:white; align-self:flex-end}
  .msg-other{background:var(--other); color:var(--muted); align-self:flex-start}
  .sidebar{width:250px; flex-shrink:0; background:var(--panel); border-right:1px solid #1f2937; padding:15px; display:flex; flex-direction:column; gap:10px}
  .typing{font-size:12px; opacity:.7}
  .online-user{padding:8px; background:#1f2937; border-radius:6px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;}
  .online-user:hover{background:#2a3447}
  .status-dot{width:8px; height:8px; border-radius:50%; margin-left:8px}
</style>
</head>
<body>
<div class="chat-container">
  <div class="sidebar">
    <div class="flex justify-between items-center mb-4">
      <h3 id="currentUsernameDisplay" class="font-bold text-lg text-blue-400">...</h3>
      <a id="logout" href="#" class="text-sm text-red-400 hover:text-red-300">Sair</a>
    </div>
    <div id="statusEl" class="text-sm">Carregando...</div>
    <div id="adminLink" class="text-sm text-yellow-400 hidden"><a href="admin.html" class="hover:underline">Painel Admin</a></div>
    <div id="friendRequests" class="text-sm space-y-2"></div>

    <h4 class="text-sm font-semibold mt-4">Online (Global)</h4>
    <div id="onlineUsersList" class="space-y-1 overflow-y-auto flex-grow"></div>
    <div id="friendList" class="mt-4 border-t border-gray-700 pt-2 space-y-1">
      <h4 class="text-sm font-semibold">Amigos (DM)</h4>
    </div>
  </div>
  
  <div class="main-chat-area">
    <div id="messages" class="messages">
      </div>
    <div id="typingIndicator" class="typing px-4 pb-2 text-sm">NinguÃ©m digitando.</div>
    <div id="blockMessage" class="px-4 py-3 bg-red-800 text-white text-sm text-center hidden">
      VocÃª estÃ¡ silenciado pelo administrador. NÃ£o Ã© possÃ­vel enviar mensagens.
    </div>
    <div class="p-4 border-t border-gray-700 flex gap-2">
      <input id="messageInput" placeholder="Digite sua mensagem (Max 500 chars, Markdown)." maxlength="500" class="flex-1 p-3 rounded bg-[#0b1220] border border-gray-700 focus:outline-none" />
      <button id="btnSend" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded disabled:opacity-50">Enviar</button>
    </div>
  </div>
</div>

<div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50">
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, get, push, set, onValue, onChildAdded, onChildChanged, onChildRemoved, serverTimestamp, onDisconnect, update, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQS7qpWTDH7itAgn1eAJIeLOfVxy__cM",
  authDomain: "chat-firebase-efcbe.firebaseapp.com",
  databaseURL: "https://chat-firebase-efcbe-default-rtdb.firebaseio.com",
  projectId: "chat-firebase-efcbe",
  storageBucket: "chat-firebase-efcbe.firebasestorage.app",
  messagingSenderId: "376919463932",
  appId: "1:376919463932:web:4b2139df551d0a026ac479",
  measurementId: "G-R14XVTJBFL"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Globals
let currentUserUid = localStorage.getItem('chat_user_uid');
let currentUsername = localStorage.getItem('chat_user_username');
let isBlocked = false;
let messageQueue = []; // Queue for messages while loading

// DOM Elements
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const btnSend = document.getElementById('btnSend');
const statusEl = document.getElementById('statusEl');
const logoutBtn = document.getElementById('logout');
const typingIndicator = document.getElementById('typingIndicator');
const onlineUsersList = document.getElementById('onlineUsersList');
const blockMessage = document.getElementById('blockMessage');
const currentUsernameDisplay = document.getElementById('currentUsernameDisplay');

// CORREÃ‡ÃƒO DE ALERTS: FunÃ§Ã£o de Toast estilizada
function showToast(message, type = 'blue') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    let bgColor = 'bg-blue-600';
    if(type === 'error') bgColor = 'bg-red-600';
    if(type === 'success') bgColor = 'bg-green-600';
    if(type === 'warning') bgColor = 'bg-yellow-600';

    toast.className = `${bgColor} text-white p-3 rounded shadow-lg text-sm transition-opacity duration-300 opacity-90`;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.addEventListener('transitionend', () => toast.remove());
    }, 4000);
}

// Utility to handle safe rendering of message content
function renderMessage(text) {
  const safeHtml = DOMPurify.sanitize(marked.parse(text));
  return safeHtml;
}

// Utility to force scroll to bottom
function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Utility for formatting time
function formatTime(timestamp) {
  try { return new Date(timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); } 
  catch(e) { return 'N/A'; }
}

// RENDER MESSAGE
function addMessageToDOM(msg, key) {
  if (document.getElementById(`msg-${key}`)) return;

  const isMine = msg.uid === currentUserUid;
  const bubble = document.createElement('div');
  bubble.id = `msg-${key}`;
  bubble.className = isMine ? 'msg-mine msg-bubble' : 'msg-other msg-bubble';
  
  const meta = document.createElement('div');
  meta.className = 'meta';
  
  const who = document.createElement('span');
  who.className = 'who';
  who.textContent = msg.username || 'UsuÃ¡rio Desconhecido';
  
  const time = document.createElement('span');
  time.className = 'time';
  time.textContent = formatTime(msg.timestamp);

  meta.appendChild(who);
  meta.appendChild(time);
  bubble.appendChild(meta);
  
  const content = document.createElement('div');
  content.innerHTML = renderMessage(msg.text);
  bubble.appendChild(content);

  messagesEl.appendChild(bubble);
  scrollToBottom();
}

// LOAD AND LISTEN GLOBAL MESSAGES
async function loadAndListenGlobal() {
  const messagesRef = ref(db, 'messages');
  onChildAdded(messagesRef, (data) => {
    addMessageToDOM(data.val(), data.key);
    // Process queued messages once the system is ready
    if(messageQueue.length > 0) {
        messageQueue.forEach(m => addMessageToDOM(m.val(), m.key));
        messageQueue = [];
    }
  }, (error) => {
    console.error("Erro ao carregar mensagens:", error);
    showToast('Erro ao carregar o histÃ³rico de mensagens.', 'error'); // CORREÃ‡ÃƒO DE ALERT
  });
}

// SEND MESSAGE
btnSend.addEventListener('click', async () => {
  if(isBlocked) {
    showToast('VocÃª estÃ¡ silenciado e nÃ£o pode enviar mensagens.', 'warning'); // CORREÃ‡ÃƒO DE ALERT
    return;
  }
  const text = messageInput.value.trim();
  if (text === '') return;

  const newMessageRef = push(ref(db, 'messages'));
  try {
    await set(newMessageRef, {
      uid: currentUserUid,
      username: currentUsername,
      text: text,
      timestamp: serverTimestamp()
    });
    messageInput.value = '';
    // After sending, clear typing status
    set(ref(db, `typing/global/${currentUserUid}`), null);
  } catch (e) {
    console.error("Erro ao enviar mensagem:", e);
    showToast('Erro ao enviar mensagem.', 'error'); // CORREÃ‡ÃƒO DE ALERT
  }
});

// PRESENCE (ONLINE STATUS)
function setupPresence() {
  onValue(ref(db, '.info/connected'), (snap) => {
    if (snap.val() === true) {
      // Set user status to online and set up onDisconnect
      set(ref(db, `status/${currentUserUid}`), { state: 'online', last_changed: Date.now() });
      onDisconnect(ref(db, `status/${currentUserUid}`)).set({ state: 'offline', last_changed: Date.now() });
      statusEl.innerHTML = '<span class="text-green-500">ðŸŸ¢ Online</span>';
    } else {
      statusEl.innerHTML = '<span class="text-red-500">ðŸ”´ Offline</span>';
    }
  });
}

// TYPING INDICATOR
function setupTyping() {
  let typingUsers = {};

  messageInput.addEventListener('input', () => {
    if (messageInput.value.length > 0) {
      set(ref(db, `typing/global/${currentUserUid}`), currentUsername);
    } else {
      set(ref(db, `typing/global/${currentUserUid}`), null);
    }
  });

  onValue(ref(db, 'typing/global'), (snap) => {
    typingUsers = snap.val() || {};
    const names = Object.entries(typingUsers)
      .filter(([uid, name]) => uid !== currentUserUid)
      .map(([uid, name]) => name);

    if (names.length > 0) {
      typingIndicator.textContent = names.join(', ') + (names.length === 1 ? ' estÃ¡ digitando...' : ' estÃ£o digitando...');
    } else {
      typingIndicator.textContent = 'NinguÃ©m digitando.';
    }
  });
}

// ONLINE USERS LIST
function setupOnlineUsersList() {
  onValue(ref(db, 'status'), async (snap) => {
    onlineUsersList.innerHTML = '';
    const statuses = snap.val() || {};
    const uids = Object.keys(statuses).filter(uid => statuses[uid].state === 'online' && uid !== currentUserUid);

    for (const uid of uids) {
      const status = statuses[uid];
      const userSnap = await get(ref(db, `users/${uid}`));
      if (!userSnap.exists()) continue;

      const user = userSnap.val();
      const userEl = document.createElement('div');
      userEl.className = 'online-user';
      userEl.innerHTML = `
        <span>${user.username}</span>
        <span class="status-dot bg-green-500"></span>
      `;
      userEl.onclick = () => window.open(`profile.html?uid=${uid}`, '_blank');
      onlineUsersList.appendChild(userEl);
    }
  });
}

// ADMIN LINK & FORCE LOGOUT
async function watchForceLogout() {
  const userRef = ref(db, `users/${currentUserUid}`);
  onValue(userRef, (snap) => {
    const user = snap.val();
    if (!user) return;
    
    // Check for isBlocked
    const wasBlocked = isBlocked;
    isBlocked = user.isBlocked || false;
    
    if (isBlocked) {
      messageInput.disabled = true;
      btnSend.disabled = true;
      blockMessage.classList.remove('hidden');
      if(!wasBlocked) showToast('VocÃª foi silenciado por um administrador.', 'warning'); // CORREÃ‡ÃƒO DE ALERT
    } else {
      messageInput.disabled = false;
      btnSend.disabled = false;
      blockMessage.classList.add('hidden');
      if(wasBlocked) showToast('Seu silÃªncio foi removido. VocÃª pode voltar a falar.', 'success'); // CORREÃ‡ÃƒO DE ALERT
    }

    // Check for forceLogoutAt
    if (user.forceLogoutAt) {
      if (Date.now() - user.forceLogoutAt < 5000) { // Check if flag is recent
        showToast('VocÃª foi desconectado forÃ§adamente por um administrador.', 'error'); // CORREÃ‡ÃƒO DE ALERT
        setTimeout(() => {
          signOut(auth);
          localStorage.clear();
          location.href = 'index.html';
        }, 1500);
      }
    }
    
    // Admin link visibility
    displayAdminIf(currentUserUid);
  });
}

async function displayAdminIf(uid) {
  const adminSnap = await get(ref(db, `admins/${uid}`));
  if (adminSnap.exists() && adminSnap.val() === true) {
    document.getElementById('adminLink').classList.remove('hidden');
  } else {
    document.getElementById('adminLink').classList.add('hidden');
  }
}

// FRIEND REQUESTS/DM (minimal implementation)
const friendRequestsEl = document.getElementById('friendRequests');
const friendListEl = document.getElementById('friendList');

function roomIdFor(uid1, uid2) {
    return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
}

async function watchFriendsAndRequests() {
    // ImplementaÃ§Ã£o simplificada de pedidos de amizade e lista de amigos
    // Apenas para evitar erros de referÃªncia no cÃ³digo existente
    friendRequestsEl.innerHTML = '<p class="text-xs opacity-70">Sem pedidos de amizade.</p>';
    friendListEl.innerHTML += '<p class="text-xs opacity-70">Nenhum amigo online.</p>';
}

// BOOTSTRAP
async function bootstrap() {
  if (!currentUserUid || !currentUsername) {
    location.href = 'index.html';
    return;
  }
  
  // 1. Ensure Auth State
  await signInAnonymously(auth);
  
  currentUsernameDisplay.textContent = currentUsername;

  // 2. Setup Listeners
  setupPresence();
  setupTyping();
  setupOnlineUsersList();
  watchForceLogout();
  watchFriendsAndRequests();
  
  // 3. Load Messages
  loadAndListenGlobal();

  // Logout Handler
  logoutBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      showToast('Desconectando...', 'warning'); // CORREÃ‡ÃƒO DE ALERT
      await signOut(auth);
      localStorage.clear();
      location.href = 'index.html';
    } catch (e) {
      console.error(e);
    }
  });
}

bootstrap();
</script>
</body>
</html>
