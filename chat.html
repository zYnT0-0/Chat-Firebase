<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat â€” App</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
<style>
  :root{
    --bg:#0d1117; --panel:#0f1418; --muted:#c9d1d9;
    --mine:#5865F2; --other:#2f3136;
  }
  body{background:var(--bg); color:var(--muted); font-family:Inter,system-ui; margin:0}
  .msg-bubble{display:inline-block; word-break:break-word; white-space:pre-wrap; border-radius:12px; padding:12px}
  .meta{font-size:12px; opacity:0.75; margin-bottom:6px; display:flex; gap:8px; align-items:center}
  .meta .who{font-weight:600}
  .meta .time{font-size:11px; opacity:0.6}
  .actions{display:flex; gap:8px; margin-top:8px}
  .small-btn{font-size:12px; padding:4px 8px; border-radius:8px}
  /* animation */
  @keyframes fadeIn{from{opacity:0; transform:translateY(6px)}to{opacity:1; transform:none}}
  .fade{animation:fadeIn .18s ease-out}
  /* responsive friends overlay */
  #friendsOverlay{display:none}
  @media (max-width:760px){
    #friendsPanel{display:none}
    #friendsToggle{display:inline-flex}
    #friendsOverlay{display:block; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:60; padding:12px; overflow:auto}
  }
  @media (min-width:761px){
    #friendsToggle{display:none}
    #friendsPanel{display:flex}
  }
  /* input area */
  #messageInput{min-height:48px; max-height:160px; resize:none}
  /* messages sizing: width greater than height typical */
  .msg-bubble{max-width:78%}
</style>
</head>
<body class="flex flex-col h-screen">

<!-- header -->
<header class="bg-[#0f1418] p-3 flex items-center justify-between border-b border-gray-800">
  <div class="flex items-center gap-3">
    <button id="friendsToggle" class="text-sm px-2 py-1 bg-gray-800 rounded hidden">Amigos</button>
    <strong class="text-sm">Chat AnÃ´nimo</strong>
    <div id="status" class="text-xs text-gray-400 ml-2">Conectando...</div>
  </div>

  <div class="flex items-center gap-3">
    <nav class="flex gap-2">
      <button id="tabGlobal" class="px-3 py-1 rounded bg-gray-800 text-sm">Global</button>
      <button id="tabDM" class="px-3 py-1 rounded text-sm">Mensagens</button>
    </nav>
    <a href="index.html" class="text-xs text-gray-400">Sair</a>
    <a href="admin.html" id="adminLink" class="text-xs text-red-400 hidden">Admin</a>
  </div>
</header>

<!-- main area -->
<div class="flex-1 flex overflow-hidden">
  <!-- messages main column -->
  <main id="mainColumn" class="flex-1 flex flex-col">
    <div id="messages" class="flex-1 overflow-auto p-4 space-y-3" style="background:#161b22"></div>

    <!-- input -->
    <section class="bg-[#0f1418] p-3 border-t border-gray-800 flex gap-3 items-start">
      <textarea id="messageInput" placeholder="Escreva..." class="flex-1 p-2 rounded bg-[#0f1418] border border-gray-700 text-sm" rows="2"></textarea>
      <div class="flex flex-col gap-2">
        <button id="sendBtn" class="bg-blue-600 px-4 py-2 rounded text-sm">Enviar</button>
        <div id="sendMode" class="text-xs text-gray-400">Modo: Global</div>
      </div>
    </section>
  </main>

  <!-- friends panel (desktop) -->
  <aside id="friendsPanel" class="w-80 bg-[#0f1418] border-l border-gray-800 p-3 hidden md:flex flex-col">
    <input id="friendSearchDesktop" placeholder="Pesquisar usuÃ¡rios..." class="w-full p-2 rounded bg-[#0f1418] border border-gray-700 text-sm mb-3" />
    <div id="recommendationsDesktop" class="space-y-2 mb-3"></div>
    <div>
      <h4 class="text-sm mb-2">Seus amigos</h4>
      <div id="friendsAreaDesktop" class="space-y-2 max-h-[40vh] overflow:auto"></div>
    </div>
    <div class="mt-auto text-xs text-gray-400">NotificaÃ§Ãµes: <span id="notifCount">0</span></div>
  </aside>
</div>

<!-- friends overlay (mobile) -->
<div id="friendsOverlay" class="hidden">
  <div class="bg-[#0f1418] rounded p-3 h-full">
    <div class="flex gap-2 mb-3">
      <input id="friendSearch" placeholder="Pesquisar usuÃ¡rios..." class="flex-1 p-2 rounded bg-[#0f1418] border border-gray-700 text-sm" />
      <button id="closeFriends" class="px-3 py-2 bg-gray-700 rounded">Fechar</button>
    </div>
    <div id="recommendations" class="space-y-2"></div>
    <div class="mt-4">
      <h4 class="text-sm mb-2">Seus amigos</h4>
      <div id="friendsArea" class="space-y-2"></div>
    </div>
  </div>
</div>

<script type="module">
/* Chat completo: global + DMs + friends + requests + presence + edits
   Requisitos:
   - localStorage.chat_user_uid
   - localStorage.chat_user_username
   - Realtime DB rules configured (we discussed)
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import {
  getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved,
  get, set, update, onValue, remove
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQS7qpWTDH7itAgn1eAJIeLOfVxy__cM",
  authDomain: "chat-firebase-efcbe.firebaseapp.com",
  databaseURL: "https://chat-firebase-efcbe-default-rtdb.firebaseio.com",
  projectId: "chat-firebase-efcbe",
  storageBucket: "chat-firebase-efcbe.firebasestorage.app",
  messagingSenderId: "376919463932",
  appId: "1:376919463932:web:4b2139df551d0a026ac479",
  measurementId: "G-R14XVTJBFL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
signInAnonymously(auth).catch(()=>{});

// session
const currentUserUid = localStorage.getItem('chat_user_uid');
let currentUsername = localStorage.getItem('chat_user_username') || 'AnÃ´nimo';
if(!currentUserUid){ location.href = 'index.html'; }

// UI refs
const statusEl = document.getElementById('status');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const sendModeEl = document.getElementById('sendMode');

const friendsToggle = document.getElementById('friendsToggle');
const friendsOverlay = document.getElementById('friendsOverlay');
const friendsPanel = document.getElementById('friendsPanel');
const friendSearch = document.getElementById('friendSearch');
const friendSearchDesktop = document.getElementById('friendSearchDesktop');
const recommendations = document.getElementById('recommendations');
const recommendationsDesktop = document.getElementById('recommendationsDesktop');
const friendsArea = document.getElementById('friendsArea');
const friendsAreaDesktop = document.getElementById('friendsAreaDesktop');
const closeFriends = document.getElementById('closeFriends');

const tabGlobal = document.getElementById('tabGlobal');
const tabDM = document.getElementById('tabDM');
const adminLink = document.getElementById('adminLink');
const notifCountEl = document.getElementById('notifCount');

const markedParse = window.marked;

// helpers
function renderMarkdown(md){
  const html = markedParse.parse(md || '');
  return DOMPurify.sanitize(html);
}
function timeStr(ts){
  try{ return new Date(ts).toLocaleTimeString(); }catch(e){ return ''; }
}
function createMessageElement(id, data, isPrivate=false){
  const wrapper = document.createElement('div');
  wrapper.className = 'fade flex';
  wrapper.style.justifyContent = (data.userId === currentUserUid) ? 'flex-end' : 'flex-start';

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.style.background = (data.userId === currentUserUid) ? 'var(--mine)' : 'var(--other)';
  bubble.style.color = (data.userId === currentUserUid) ? 'white' : '#d6dbe3';
  bubble.style.maxWidth = '78%';

  // header meta
  const meta = document.createElement('div');
  meta.className = 'meta';
  const who = document.createElement('div');
  who.className = 'who';
  who.textContent = data.username || 'AnÃ´nimo';
  const t = document.createElement('div');
  t.className = 'time';
  t.textContent = (data.timestamp) ? `â€¢ ${timeStr(data.timestamp)}` : '';
  meta.appendChild(who); meta.appendChild(t);

  const content = document.createElement('div');
  content.className = 'content';
  content.innerHTML = renderMarkdown(data.text);

  bubble.appendChild(meta);
  bubble.appendChild(content);

  // actions only for author
  if(data.userId === currentUserUid){
    const actions = document.createElement('div');
    actions.className = 'actions';
    const editBtn = document.createElement('button');
    editBtn.className = 'small-btn text-xs text-gray-200';
    editBtn.textContent = 'editar';
    const delBtn = document.createElement('button');
    delBtn.className = 'small-btn text-xs text-red-400';
    delBtn.textContent = 'apagar';

    editBtn.onclick = ()=> openModal('Editar mensagem', data.text, async (newText)=>{
      if(!newText.trim()) return;
      const path = isPrivate ? `privateMessages/${currentRoomId}/messages/${id}` : `messages/${id}`;
      await update(ref(db, path), { text:newText, editedAt: Date.now() });
    });

    delBtn.onclick = ()=> openModal('Apagar mensagem', 'Tem certeza?', async ()=>{
      const path = isPrivate ? `privateMessages/${currentRoomId}/messages/${id}` : `messages/${id}`;
      await remove(ref(db, path));
    }, true);

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    bubble.appendChild(actions);
  }

  wrapper.appendChild(bubble);
  wrapper.dataset.msgId = id;
  return wrapper;
}

// modal
function openModal(title, content, onConfirm, confirmOnly=false){
  const modal = document.createElement('div');
  Object.assign(modal.style, {position:'fixed', inset:0, background:'rgba(0,0,0,0.6)', display:'flex', alignItems:'center', justifyContent:'center', zIndex:90});
  const box = document.createElement('div');
  Object.assign(box.style, {background:'#111318', padding:'14px', borderRadius:'8px', width:'92%', maxWidth:'420px'});
  const h = document.createElement('h3'); h.textContent = title; h.className='text-sm mb-2'; box.appendChild(h);
  let inputEl = null;
  if(!confirmOnly){
    inputEl = document.createElement('textarea');
    inputEl.className = 'w-full p-2 rounded bg-[#0f1418] border border-gray-700 mb-3';
    inputEl.value = content || '';
    box.appendChild(inputEl);
  } else {
    const p = document.createElement('p'); p.className='text-xs mb-3'; p.textContent = content; box.appendChild(p);
  }
  const row = document.createElement('div'); row.className = 'flex justify-end gap-2';
  const bCancel = document.createElement('button'); bCancel.className='px-3 py-1 bg-gray-700 rounded'; bCancel.textContent='Cancelar';
  const bOk = document.createElement('button'); bOk.className='px-3 py-1 bg-blue-600 rounded'; bOk.textContent='Confirmar';
  bCancel.onclick = ()=> modal.remove();
  bOk.onclick = async ()=>{
    await onConfirm(inputEl ? inputEl.value : '');
    modal.remove();
  };
  row.appendChild(bCancel); row.appendChild(bOk);
  box.appendChild(row); modal.appendChild(box); document.body.appendChild(modal);
}

// presence
onValue(ref(db, '.info/connected'), snap=>{
  if(snap.val()===true){
    set(ref(db, `status/${currentUserUid}`), { state:'online', last_changed: Date.now() });
    // ensure offline on unload
    window.addEventListener('beforeunload', ()=> {
      try{ set(ref(db, `status/${currentUserUid}`), { state:'offline', last_changed: Date.now() }); }catch(e){}
    });
    statusEl.innerHTML = '<span class="text-green-500">ðŸŸ¢ Online</span>';
  } else {
    statusEl.innerHTML = '<span class="text-red-500">ðŸ”´ Offline</span>';
  }
});

// admin link
(async function(){
  const s = await get(ref(db, `admins/${currentUserUid}`));
  if(s.exists() && s.val()===true) adminLink.classList.remove('hidden');
})();

// GLOBAL messages listeners
const globalRef = ref(db, 'messages');
const displayedGlobal = new Set();

function appendGlobalMessage(id, data){
  if(displayedGlobal.has(id)) return;
  displayedGlobal.add(id);
  const node = createMessageElement(id, data, false);
  node.classList.add('fade');
  messagesEl.appendChild(node);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

onChildAdded(globalRef, snap=>{
  appendGlobalMessage(snap.key, snap.val());
});
onChildChanged(globalRef, snap=>{
  // replace message in DOM
  rebuildGlobalMessages();
});
onChildRemoved(globalRef, snap=>{ rebuildGlobalMessages(); });

async function rebuildGlobalMessages(){
  messagesEl.innerHTML = '';
  displayedGlobal.clear();
  const s = await get(globalRef);
  if(!s.exists()) return;
  const msgs = s.val();
  Object.keys(msgs).forEach(k=>{
    displayedGlobal.add(k);
    messagesEl.appendChild(createMessageElement(k, msgs[k], false));
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// PRIVATE chat support
let currentRoomId = null; // chatId 'uidA_uidB' sorted
let privateListeners = { added:null, changed:null, removed:null };

function roomIdFor(u1, u2){
  const arr = [u1, u2].sort();
  return `${arr[0]}_${arr[1]}`;
}
async function ensurePrivateRoom(u1,u2){
  const id = roomIdFor(u1,u2);
  const roomRef = ref(db, `privateMessages/${id}`);
  const snap = await get(roomRef);
  if(!snap.exists()){
    // create participants node for rules
    await set(ref(db, `privateMessages/${id}/participants/${u1}`), true);
    await set(ref(db, `privateMessages/${id}/participants/${u2}`), true);
  } else {
    // ensure participants exist
    await set(ref(db, `privateMessages/${id}/participants/${u1}`), true);
    await set(ref(db, `privateMessages/${id}/participants/${u2}`), true);
  }
  return id;
}

async function openPrivateRoomWith(uid, username){
  currentRoomId = await ensurePrivateRoom(currentUserUid, uid);
  // switch to DM tab
  tabDM.click();
  // load messages of room
  await rebuildPrivateMessages(currentRoomId);
  sendModeEl.textContent = `Modo: DM (${username})`;
}

// private messages functions
async function rebuildPrivateMessages(roomId){
  // remove any existing listeners
  if(privateListeners.added) privateListeners.added(); // no-op since modular doesn't return unsubscribe here; we will just rebuild
  const msgsRef = ref(db, `privateMessages/${roomId}/messages`);
  const s = await get(msgsRef);
  messagesEl.innerHTML = '';
  if(!s.exists()) return;
  const msgs = s.val();
  Object.keys(msgs).forEach(k=>{
    messagesEl.appendChild(createMessageElement(k, msgs[k], true));
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// send handler (global or private depending on currentRoomId)
sendBtn.addEventListener('click', async ()=>{
  const text = messageInput.value.trim();
  if(!text) return;
  // check ban
  const userSnap = await get(ref(db, `users/${currentUserUid}`));
  if(userSnap.exists() && userSnap.val().isBanned){ alert('VocÃª foi banido.'); return; }

  if(currentRoomId){
    // private
    const msgsRef = ref(db, `privateMessages/${currentRoomId}/messages`);
    await push(msgsRef, { userId: currentUserUid, username: currentUsername, text, timestamp: Date.now() });
  } else {
    // global
    await push(ref(db, 'messages'), { userId: currentUserUid, username: currentUsername, text, timestamp: Date.now() });
  }
  messageInput.value = '';
});

// FRIENDS: load friends list
async function loadFriendsUI(){
  // desktop and mobile areas
  friendsArea.innerHTML = ''; friendsAreaDesktop.innerHTML = '';
  const s = await get(ref(db, `users/${currentUserUid}/friends`));
  if(!s.exists()) return;
  const f = s.val();
  for(const uid of Object.keys(f)){
    const name = f[uid].username || uid;
    const btn = document.createElement('button');
    btn.className = 'w-full text-left px-3 py-2 bg-gray-800 rounded';
    btn.textContent = name;
    btn.onclick = ()=> openPrivateRoomWith(uid, name);
    friendsArea.appendChild(btn);
    const btn2 = btn.cloneNode(true);
    btn2.onclick = btn.onclick;
    friendsAreaDesktop.appendChild(btn2);
  }
}
loadFriendsUI();

// SEARCH & RECOMMENDATIONS
async function searchRecommendations(q, outEl){
  outEl.innerHTML = '';
  if(!q) return;
  const snap = await get(ref(db, 'usernames'));
  if(!snap.exists()) return;
  const all = snap.val();
  // show up to some results; ignore current user's username
  let added=0;
  for(const unameKey of Object.keys(all)){
    if(added>10) break;
    if(unameKey.includes(q.toLowerCase())){
      const uid = all[unameKey];
      if(uid === currentUserUid) continue; // ignore self
      const userSnap = await get(ref(db, `users/${uid}`));
      if(!userSnap.exists()) continue;
      const user = userSnap.val();
      const row = document.createElement('div');
      row.className = 'p-2 bg-[#111318] rounded flex justify-between items-center';
      const name = document.createElement('div'); name.textContent = user.username;
      const addBtn = document.createElement('button'); addBtn.textContent = 'Adicionar'; addBtn.className = 'small-btn bg-blue-600 text-white';
      addBtn.onclick = async ()=>{
        // send friend request: /friendRequests/{toUid}/{fromUid} = {username, from}
        await set(ref(db, `friendRequests/${uid}/${currentUserUid}`), { username: currentUsername, from: currentUserUid, at: Date.now() });
        addBtn.textContent = 'Enviado';
      };
      row.appendChild(name); row.appendChild(addBtn);
      outEl.appendChild(row);
      added++;
    }
  }
}

// wire search inputs
friendSearch.addEventListener('input', (e)=> searchRecommendations(e.target.value, recommendations));
friendSearchDesktop.addEventListener('input', (e)=> searchRecommendations(e.target.value, recommendationsDesktop));

// friendsOverlay toggle
friendsToggle.onclick = ()=> { friendsOverlay.classList.toggle('hidden'); friendsOverlay.style.display = friendsOverlay.classList.contains('hidden') ? 'none' : 'block'; };
closeFriends.onclick = ()=> { friendsOverlay.classList.add('hidden'); friendsOverlay.style.display = 'none'; };

// Friend requests notifications (listen to incoming requests)
onChildAdded(ref(db, `friendRequests/${currentUserUid}`), snap=>{
  // increase notif count
  const count = parseInt(notifCountEl.textContent||'0',10) + 1;
  notifCountEl.textContent = count;
});

// Accept friend request logic (not a full UI here, but available via admin/profile)
// When accepting, both users get added under /users/{uid}/friends/{friendUid} with username

// TABS: Global / DM
tabGlobal.onclick = async ()=>{
  currentRoomId = null;
  sendModeEl.textContent = 'Modo: Global';
  // show global messages: rebuild
  await rebuildGlobalMessages();
};
tabDM.onclick = async ()=>{
  // start with empty DM view: show friends list or prompt
  messagesEl.innerHTML = '<div class="text-gray-400">Selecione um amigo para abrir DM.</div>';
  sendModeEl.textContent = 'Modo: DM (nenhum)';
};

// initial load: global
tabGlobal.click();

// handle live updates for changes/removals on globals handled above rebuild functions

// listen for changes in messages and reflect in DOM (optimized)
onChildChanged(ref(db,'messages'), snap=>{
  // replace existing node if present
  const id = snap.key;
  const nodes = messagesEl.querySelectorAll('[data-msg-id]');
  for(const n of nodes){
    if(n.dataset.msgId === id){
      const newNode = createMessageElement(id, snap.val(), false);
      n.replaceWith(newNode);
      return;
    }
  }
});
onChildRemoved(ref(db,'messages'), snap=>{
  const id = snap.key;
  const n = messagesEl.querySelector(`[data-msg-id="${id}"]`);
  if(n) n.remove();
});

// Rebuild friends periodically or on events
onValue(ref(db, `users/${currentUserUid}/friends`), snap=> loadFriendsUI());

// Also watch status changes to show online in friends list (optional)
onValue(ref(db, 'status'), snap=>{
  // could update small badges next to friends in lists (left as exercise)
});

// quick utility: accept friend request if desired (example):
async function acceptFriendRequest(fromUid){
  // add both ways
  const fromSnap = await get(ref(db, `users/${fromUid}`));
  if(!fromSnap.exists()) return;
  const fromName = fromSnap.val().username;
  await set(ref(db, `users/${currentUserUid}/friends/${fromUid}`), { username: fromName, addedAt: Date.now() });
  await set(ref(db, `users/${fromUid}/friends/${currentUserUid}`), { username: currentUsername, addedAt: Date.now() });
  // remove the friendRequest
  await remove(ref(db, `friendRequests/${currentUserUid}/${fromUid}`));
  notifCountEl.textContent = Math.max(0, parseInt(notifCountEl.textContent||'0',10) - 1);
  loadFriendsUI();
}

// Expose acceptFriendRequest for console/testing (or later add UI)
window.acceptFriendRequest = acceptFriendRequest;

</script>
</body>
</html>
