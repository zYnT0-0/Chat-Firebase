<!doctype html>
<html lang="pt-BR"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Perfil</title><script src="https://cdn.tailwindcss.com"></script></head><body class="bg-[#0d1117] text-[#c9d1d9] p-6">
<a href="chat.html" class="text-sm text-gray-400 hover:text-white mb-4 block">&larr; Voltar ao Chat</a>
<h2 class="text-lg mb-3">Perfil do Usu√°rio</h2>
<div id="info" class="bg-[#111318] p-4 rounded"></div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
const firebaseConfig = {
  "apiKey": "AIzaSyDAQS7qpWTDH7itAgn1eAJIeLOfVxy__cM",
  "authDomain": "chat-firebase-efcbe.firebaseapp.com",
  "databaseURL": "https://chat-firebase-efcbe-default-rtdb.firebaseio.com",
  "projectId": "chat-firebase-efcbe",
  "storageBucket": "chat-firebase-efcbe.firebasestorage.app",
  "messagingSenderId": "376919463932",
  "appId": "1:376919463932:web:4b2139df551d0a026ac479",
  "measurementId": "G-R14XVTJBFL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

signInAnonymously(auth).catch((e)=>{ console.error("Erro na autentica√ß√£o an√¥nima:", e); });

const urlParams = new URLSearchParams(window.location.search);
const currentUserUid = localStorage.getItem('chat_user_uid');

// Se a URL tem 'uid', usa ele como alvo. Sen√£o, usa o logado.
const targetUid = urlParams.get('uid') || currentUserUid; 

if(!currentUserUid) location.href='index.html';
if(!targetUid) {
    document.getElementById('info').innerHTML = 'Perfil n√£o especificado.';
    throw new Error("Target UID not found.");
}

// Escuta os dados do usu√°rio ALVO (targetUid)
onValue(ref(db, `users/${targetUid}`), async (userSnap) => {
    if(!userSnap.exists()) {
        document.getElementById('info').innerHTML = 'Perfil n√£o encontrado.';
        return;
    }
    const u = userSnap.val();
    
    // Busca status (separadamente)
    const statusSnap = await get(ref(db, `status/${targetUid}`));
    const status = statusSnap.exists() ? statusSnap.val() : null;
    const adminSnap = await get(ref(db, `admins/${targetUid}`));
    const isAdmin = adminSnap.exists() && adminSnap.val() === true;
    
    // Calcula status online/offline
    const isOnline = status && status.state === 'online';
    const statusText = isOnline ? 
        '<span class="text-green-500">üü¢ Online</span>' : 
        `<span class="text-red-500">üî¥ Offline</span>`;

    // Verifica puni√ß√£o
    let banStatus = '';
    if (u.isBanned) banStatus = ' <span class="text-red-400">(BANIDO)</span>';
    else if (u.isBlocked) banStatus = ' <span class="text-yellow-400">(SILENCIADO)</span>';
        
    // CORRE√á√ÉO DE VAZAMENTO DE UID: O UID nunca √© exibido, nem para o pr√≥prio usu√°rio.
    const uidDisplay = 'Privado (Seguro)'; 

    document.getElementById('info').innerHTML = `
        <p class="mb-2"><strong>Nome de Usu√°rio:</strong> ${u.username}${banStatus} ${isAdmin ? '<span class="text-blue-400">(ADMIN)</span>' : ''}</p>
        <p class="mb-2"><strong>Status:</strong> ${statusText}</p>
        <p class="text-xs opacity-50 mt-4"><strong>UID:</strong> ${uidDisplay}</p>
        `;
    
    // A√ß√µes para perfis de outros usu√°rios (exemplo)
    if (targetUid !== currentUserUid) {
        let actionButtons = document.getElementById('actionButtons');
        if (!actionButtons) {
            actionButtons = document.createElement('div');
            actionButtons.id = 'actionButtons';
            document.getElementById('info').appendChild(actionButtons);
        }
        actionButtons.innerHTML = `
            <button class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded mt-3 text-sm">Adicionar Amigo (DM)</button>
        `;
    }
});
</script>
</body></html>
