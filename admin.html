<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0d1117] text-[#c9d1d9] p-6">
<h2 class="text-xl mb-4 text-red-400">ğŸš¨ Painel de AdministraÃ§Ã£o</h2>

<div class="mb-4">
    <a href="chat.html" class="text-sm text-gray-400 hover:text-white">&larr; Voltar ao Chat</a>
</div>

<div id="userList" class="space-y-3">
    <div class="text-gray-500">Carregando usuÃ¡rios...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, get, update, onValue, set } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  "apiKey": "AIzaSyDAQS7qpWTDH7itAgn1eAJIeLOfVxy__cM",
  "authDomain": "chat-firebase-efcbe.firebaseapp.com",
  "databaseURL": "https://chat-firebase-efcbe-default-rtdb.firebaseio.com",
  "projectId": "chat-firebase-efcbe",
  "storageBucket": "chat-firebase-efcbe.firebasestorage.app",
  "messagingSenderId": "376919463932",
  "appId": "1:376919463932:web:4b2139df551d0a026ac479",
  "measurementId": "G-R14XVTJBFL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const userListEl = document.getElementById('userList');

const currentUserUid = localStorage.getItem('chat_user_uid');
if(!currentUserUid) { location.href='index.html'; }

// FunÃ§Ã£o para verificar se o usuÃ¡rio Ã© administrador
async function checkAdmin(){
    const isAdmin = await get(ref(db, `admins/${currentUserUid}`)).then(s => s.exists() && s.val() === true);
    if(!isAdmin) {
        alert('Acesso negado. VocÃª nÃ£o Ã© um administrador.');
        location.href='chat.html';
        return false;
    }
    return true;
}

function renderUser(uid, user, status){
    const div = document.createElement('div');
    div.className = 'p-3 bg-[#111318] rounded border border-gray-700';
    
    // Status
    const statusText = status ? (status.state === 'online' ? 'ğŸŸ¢ Online' : `ğŸ”´ Offline (${new Date(status.last_changed).toLocaleTimeString()})`) : 'âšª Desconhecido';
    const blockedText = user.isBlocked ? ' (ğŸ¤« Silenciado)' : '';
    const bannedText = user.isBanned ? ' (ğŸ”¨ BANIDO)' : '';

    let content = `
        <div class="flex justify-between items-center mb-2">
            <strong>${user.username || uid}</strong>
            <span class="text-sm text-gray-400">${statusText}</span>
        </div>
        <div class="text-xs text-red-400 mb-3 break-all">UID: ${uid} ${blockedText} ${bannedText}</div>
        <div class="flex gap-2 text-sm flex-wrap">
            <button data-action="toggleBlock" data-uid="${uid}" data-isblocked="${user.isBlocked||false}" class="px-3 py-1 rounded ${user.isBlocked ? 'bg-green-600 hover:bg-green-700' : 'bg-yellow-600 hover:bg-yellow-700'}">
                ${user.isBlocked ? 'Desbloquear Escrita' : 'Bloquear Escrita'}
            </button>
            <button data-action="toggleBan" data-uid="${uid}" data-isbanned="${user.isBanned||false}" class="px-3 py-1 rounded ${user.isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}">
                ${user.isBanned ? 'Desbanir' : 'Banir Totalmente'}
            </button>
            <button data-action="forceLogout" data-uid="${uid}" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-700">
                ForÃ§ar Logout
            </button>
        </div>
    `;
    div.innerHTML = content;
    return div;
}

async function loadUsers(){
    userListEl.innerHTML = '';
    const usersSnap = await get(ref(db, 'users'));
    const statusSnap = await get(ref(db, 'status'));
    
    const users = usersSnap.exists() ? usersSnap.val() : {};
    const statuses = statusSnap.exists() ? statusSnap.val() : {};
    
    const userKeys = Object.keys(users).filter(uid => uid !== currentUserUid && users[uid].username);

    if(userKeys.length === 0){
        userListEl.innerHTML = '<div class="text-gray-400">Nenhum outro usuÃ¡rio encontrado.</div>';
        return;
    }

    for(const uid of userKeys){
        const userEl = renderUser(uid, users[uid], statuses[uid]);
        userListEl.appendChild(userEl);
    }
    
    // Adicionar listeners apÃ³s a renderizaÃ§Ã£o
    userListEl.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', handleAdminAction);
    });
}

async function handleAdminAction(e){
    const btn = e.target;
    const uid = btn.dataset.uid;
    const action = btn.dataset.action;

    if(!confirm(`Tem certeza que deseja executar a aÃ§Ã£o: ${action} no usuÃ¡rio ${uid}?`)) return;

    try{
        if(action === 'toggleBlock'){
            const isBlocked = btn.dataset.isblocked === 'true';
            await update(ref(db, `users/${uid}`), { isBlocked: !isBlocked });
        } else if(action === 'toggleBan'){
            const isBanned = btn.dataset.isbanned === 'true';
            await update(ref(db, `users/${uid}`), { isBanned: !isBanned });
        } else if(action === 'forceLogout'){
            await update(ref(db, `users/${uid}`), { forceLogoutAt: Date.now() });
        }
        
        loadUsers(); // Recarrega a lista
    }catch(e){
        alert('Erro ao executar aÃ§Ã£o administrativa: ' + e.message);
        console.error(e);
    }
}

// Inicia o carregamento e monitora alteraÃ§Ãµes de status (e implicitamente de users)
(async function initAdmin(){
    if(await checkAdmin()){
        // Observa mudanÃ§as nos usuÃ¡rios e status para recarregar a lista
        onValue(ref(db, 'users'), loadUsers);
        onValue(ref(db, 'status'), loadUsers);
    }
})();

</script>
</body>
</html>
